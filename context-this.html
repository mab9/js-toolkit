<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>Context / Thiss</title>
  </head>
  <body>

    This is the Context
    <script>

        ////////////////////////////////////////////////////////////////////////////
        //
        //

        const ok = [];


        ///////////////////////
        //  Object and functions
        // https://www.youtube.com/watch?v=su-SdgebJCE

        contact = {
            firstname: "Mab",

            // the printName function does not now anything about the firstName frome above
            printName: function () {
                return firstname;
                // In other classes we think about defining classes
                // and to have access to all members.
                // In JS we have no  classes. we have JS Objects.
            }
        };

        ok.push(contact.firstname === "Mab");
        ok.push(contact.printName !== "Mab");  // Reference Error fistname is not defined!


        contact = {   // In JS we have no classes. we have JS Objects!
            firstname: "Mab",
            printName: function () {
                return contact.firstname;  // reference to the variable firstname
            }
        };

        ok.push(contact.printName() === "Mab");

        let newContact = contact;
        contact = null;
        ok.push(newContact.firstname === "Mab");
        // ok.push(newContact.printName() === "Mab");  --> contatc is null!


        ///////////////////////
        //  THIS Key Word
        //  The Implementation of printName refers to contact.

        contact = {   // In JS we have no classes. we have JS Objects!
            firstname: "Mab",
            printName: function () {
                return this.firstname;
                // refers to whatever it is before the dot.
                // No coupling to the implementation.
            }
        };

        ok.push(contact.printName() === "Mab");
        newContact = contact;
        contact = null;
        ok.push(newContact.firstname === "Mab");
        ok.push(newContact.printName() === "Mab");


        ////////
        // Bob's Code

        contact = {
            firstname: "Mab",
            printName: function () {
                return this.firstname;
            },
        };

        function doCalculation(x, y, callback) {
            console.info(x + y);
            callback();
        }


        // ok.push(doCalculation(3, 4, contact.printName()) === undefined);
        // In this case we are passing a reference to the printName function
        // and we are losing the information from contact!


        ///////////////////////
        // How the JS interpreter decides what THIS should be!
        // https://www.youtube.com/watch?v=hJ_YD4Ljbqc
        // 3 main cases what this should be bound to
        //
        // - function invoked with new operator?
        // - function being invoked with a dot?

        // is function being invoked with the new Operator?
        // yes -> go to is function being invoke with a dot
        // no  -> this is bound to a new empty object.

        // is function being invoked with a dot?
        // yes -> this evaluates to the expression before the dot.
        //        Example x.f then this === x;
        // no  -> this evaluates to the global object --> window
        //        Example fz = x.f   === window.fz()






        ///////////////////////
        // .bind(this) better approach
        // https://www.youtube.com/watch?v=PNqoehDEZ3E

        contact = {
            firstname: "Mab",
            printName: function () {
                console.info(this.firstname);
            },

            /*
            printLater: function () {
                setTimeout(contact.printName, 1500);
                // Reference printName is passed -> will not work
            }
            */
            printLater: function () {
                var that = this;
                setTimeout(function () {        /// this solution will add a lot of x#"!@ to the global scope!
                    that.printName();
                }, 1500);
            },


            // bind
            printLaterBetter: function () {
                setTimeout(this.printName.bind(this), 1500);
                // bind returns a new function with this and the other
                // variables..      // Code reuse
            },

            printLaterAllCaps: function () {
                setTimeout(function () {
                    console.info(this.firstname.toUpperCase());
                }.bind(this), 1500)     // pass the result of the bind code
            },

            printLaterAllCapsBetter: function () {
                setTimeout(() => {
                    console.info(this.firstname.toUpperCase());
                }, 1500)     // pass the result of the bind code
            }
        };

        contact.printName();
        contact.printLater();
        contact.printLaterBetter();  // check the console!





        ///////////////////////
        // Arrow Syntax => to automatically bind .bind(this)
        // https://www.youtube.com/watch?v=QQ4__W9nELc

        contact.printLaterAllCaps();
        contact.printLaterAllCapsBetter();
        // works only with ECMA 6 with arrow syntax

        // other techniques
        contact.printName(); // run printName with a dot
        let f = contact.printName;
        f(); // run printName without a dot  will print undefined!

        f.call(contact);
        f.apply(contact);
        // the difference is how to pass other parameter




        ////////////////////////////////////////////////////////////////////////////
        // test result report
        if (ok.every(elem => elem)) {
            document.writeln("<p></p>");
            document.writeln("All " + ok.length + " tests ok.");
        } else {
            document.writeln("Not all tests ok! Details:");
            for (let i = 0; i < ok.length; i++) {
                document.writeln("<p></p>");
                if (ok[i]) {
                    document.writeln("Test " + i + " ok");
                } else {
                    document.writeln("Test " + i + " failed");
                }
            }
        }

    </script>
  </body>
</html>










